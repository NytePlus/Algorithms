---
---

假面舞会：[https://www.luogu.com.cn/problem/P1477](https://www.luogu.com.cn/problem/P1477)

## 思考

对图进行dfs，通过前序、后序编号可以判断横跨边、后向边、前向边。

一个环可能包含多个**横跨边**，这导致dfs无法找到所有环。它只能找到一个**后向边**到祖先的环。

## 完整的情况

完整的情况是：
- 没有公共部分的两个环：面具数最多是两个环大小的最大公约数
- 有公共部分（共用连续的几个点）的两个环：面具数最多是两个环大小的最大公约数
- 有公共部分（共用头尾）的两个链：面具数最多是两个环长度差的约数
- 没有公共部分的两个链也没有环：面具数最多为所有链长度之和（这个情况需要特殊处理）

## 遍历公共环

通过建立边权为负的反向边，任何**非树边**都对应一个环或两个有公共部分的链组成的环。dfs时累加边权可能是正或负，这会导致两种情况处理相同

一个环：求最大公约数即可，累加路径对于求公约数是等价的。

有公共部分的两个链组成的环：累加路径即为两链长度差，求最大公约数即可

## 环遍历公约数等价

假如有两个圈，原来的边如图所示。别忘了，我们为这个原边添加了反向边。

![](https://cdn.luogu.com.cn/upload/image_hosting/jwki6g60.png)

从S开始dfs，可能遇到$a$、$c-b$或$b+a-c$。他们的公约数是相同的，比如证明$gcd(a, a + b - c) = gcd(a, ∣c−b∣)$

### c < b:
$$
右 = gcd(a, b - c) = gcd(a, a + b - c) = 左
$$

### c > b:
由定理$gcd(x, y) = gcd(y, x - y)$有
$$
右 = gcd(a, c - b) = gcd(a, a + c - b)
$$

令$x = b - c$，即证
$$
右 = gcd(a, a - x) = gcd(a, a + x) = 左
$$

这个式子有简单的证明方法，即证互相为对方的因数


**证明：**
设 \(d = \gcd(a, a - b)\) 和 \(d' = \gcd(a, a + b)\)。我们需要证明 \(d = d'\)。

首先，注意：
- \(d \mid a\) 且 \(d \mid (a - b)\)，所以 \(d \mid b\)（因为 \(b = a - (a - b)\)）。
- 类似地，\(d' \mid a\) 且 \(d' \mid (a + b)\)，所以 \(d' \mid b\)（因为 \(b = (a + b) - a\)）。

现在，考虑：
1. 由于 \(d \mid a\) 且 \(d \mid b\)，则 \(d \mid (a + b)\)。因此 \(d\) 是 \(a\) 和 \(a + b\) 的公因数，所以 \(d \mid d'\)。
2. 由于 \(d' \mid a\) 且 \(d' \mid b\)，则 \(d' \mid (a - b)\)。因此 \(d'\) 是 \(a\) 和 \(a - b\) 的公因数，所以 \(d' \mid d\).

由 \(d \mid d'\) 和 \(d' \mid d\)，可得 \(d = d'\)。

因此，\(\gcd(a, a - b) = \gcd(a, a + b)\)。
